<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Suivi d'Ã©pargne vers objectif personnalisÃ©</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #e3f2fd, #e8f5e9);
      margin: 0;
      padding: 2rem;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 2rem;
      border-radius: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: #2e7d32;
    }
    label {
      display: block;
      margin: 1rem 0 0.5rem;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 0.6rem;
      font-size: 1rem;
      border: 1px solid #cfd8dc;
      border-radius: 0.75rem;
      background-color: #f9f9f9;
      transition: border-color 0.2s ease;
    }
    input:focus, select:focus {
      border-color: #64b5f6;
      outline: none;
    }
    button {
      margin-top: 1rem;
      width: 100%;
      padding: 0.8rem;
      font-size: 1rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #388e3c;
    }
    .reset-button {
      background: #e53935;
    }
    .reset-button:hover {
      background: #b71c1c;
    }
    .result, .history {
      margin-top: 2rem;
      background: #e8f5e9;
      padding: 1rem;
      border-radius: 1rem;
      border-left: 5px solid #66bb6a;
    }
    .progress-bar-container {
      width: 100%;
      background: #cfd8dc;
      border-radius: 1rem;
      margin-top: 1rem;
      overflow: hidden;
    }
    .progress-bar {
      height: 24px;
      background: linear-gradient(to right, #4CAF50, #81C784);
      width: 0%;
      color: white;
      text-align: center;
      line-height: 24px;
      font-size: 0.9rem;
      transition: width 0.4s ease-in-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Suivi d'Ã©pargne</h2>
    <p style="text-align:center;">
      <a href="https://www.traderepublic.com/fr-fr" target="_blank" style="color:#4CAF50; text-decoration:none; font-weight:bold;">
        âž• Aller sur Trade Republic pour Ã©pargner
      </a>
    </p>

    <label for="objectif">Objectif d'Ã©pargne (â‚¬)</label>
    <input type="number" id="objectif" value="10000" oninput="updateProgress()" />

    <label for="mois">Mois</label>
    <select id="mois">
      <option>Janvier</option>
      <option>FÃ©vrier</option>
      <option>Mars</option>
      <option>Avril</option>
      <option>Mai</option>
      <option>Juin</option>
      <option>Juillet</option>
      <option>AoÃ»t</option>
      <option>Septembre</option>
      <option>Octobre</option>
      <option>Novembre</option>
      <option>DÃ©cembre</option>
    </select>

    <label for="revenu">Revenu du mois (â‚¬)</label>
    <input type="number" id="revenu" />

    <label for="depenses">DÃ©penses du mois (â‚¬)</label>
    <input type="number" id="depenses" />

    <label for="epargne">Montant mis sur Trade Republic (â‚¬)</label>
    <input type="number" id="epargne" />

    <button onclick="calculer()">Ajouter et Calculer</button>
    <button class="reset-button" onclick="resetAll()">RÃ©initialiser</button>

    <div class="result" id="resultat" style="display:none;"></div>
    <div class="progress-bar-container">
      <div id="progressBar" class="progress-bar">0%</div>
    </div>
    <div class="history" id="historique"></div>
    <canvas id="capitalChart" width="400" height="200" style="margin-top:2rem;"></canvas>
  </div>

  <script>
    let capital = localStorage.getItem("capital") ? parseFloat(localStorage.getItem("capital")) : 1500;
    let mois_num = localStorage.getItem("mois_num") ? parseInt(localStorage.getItem("mois_num")) : 0;
    let historiqueLabels = JSON.parse(localStorage.getItem("historiqueLabels") || "[]");
    let historiqueCapital = JSON.parse(localStorage.getItem("historiqueCapital") || "[]");

    const ctx = document.getElementById('capitalChart').getContext('2d');
    const capitalChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: historiqueLabels,
        datasets: [{
          label: 'Capital (â‚¬)',
          data: historiqueCapital,
          borderColor: '#4CAF50',
          backgroundColor: 'rgba(76, 175, 80, 0.1)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    function updateProgress() {
      const objectif = parseFloat(document.getElementById("objectif").value) || 10000;
      const percent = Math.min((capital / objectif) * 100, 100).toFixed(1);
      const progress = document.getElementById("progressBar");
      progress.style.width = percent + "%";
      progress.innerText = percent + "%";
    }

    function calculer() {
      const moisNom = document.getElementById('mois').value;
      const revenu = parseFloat(document.getElementById('revenu').value);
      const depenses = parseFloat(document.getElementById('depenses').value);
      const epargne = parseFloat(document.getElementById('epargne').value);
      const interets = capital * (0.02 / 12);
      const objectif = parseFloat(document.getElementById("objectif").value);

      if (isNaN(revenu) || isNaN(depenses) || isNaN(epargne)) {
        alert("Merci de remplir tous les champs.");
        return;
      }

      capital += epargne + interets;
      mois_num++;
      localStorage.setItem("capital", capital);
      localStorage.setItem("mois_num", mois_num);

      updateProgress();

      historiqueLabels.push(moisNom);
      historiqueCapital.push(capital);
      localStorage.setItem("historiqueLabels", JSON.stringify(historiqueLabels));
      localStorage.setItem("historiqueCapital", JSON.stringify(historiqueCapital));
      capitalChart.update();

      const res = document.getElementById('resultat');
      res.style.display = 'block';
      res.innerHTML = `
        <strong>${moisNom} (Mois ${mois_num})</strong><br>
        Revenu : ${revenu} â‚¬<br>
        DÃ©penses : ${depenses} â‚¬<br>
        Epargne versÃ©e : ${epargne} â‚¬<br>
        IntÃ©rÃªts ce mois : ${interets.toFixed(2)} â‚¬<br>
        <hr>
        <strong>Capital total estimÃ© : ${capital.toFixed(2)} â‚¬</strong><br>
        <strong>Objectif ${objectif} â‚¬ : ${capital >= objectif ? 'Atteint ðŸŽ‰' : 'En cours...'}</strong>
      `;

      const historique = document.getElementById("historique");
      const entry = document.createElement("div");
      entry.className = "history-entry";
      entry.innerHTML = `<strong>${moisNom}</strong> - Revenu: ${revenu} â‚¬, DÃ©penses: ${depenses} â‚¬, Epargne: ${epargne} â‚¬, Capital: ${capital.toFixed(2)} â‚¬`;
      historique.prepend(entry);

      document.getElementById('revenu').value = '';
      document.getElementById('depenses').value = '';
      document.getElementById('epargne').value = '';
    }

    function resetAll() {
      localStorage.clear();
      capital = 1500;
      mois_num = 0;
      historiqueLabels.length = 0;
      historiqueCapital.length = 0;
      capitalChart.data.labels = [];
      capitalChart.data.datasets[0].data = [];
      capitalChart.update();
      document.getElementById('resultat').style.display = 'none';
      document.getElementById('historique').innerHTML = '';
      updateProgress();
    }

    function verifierRappelMensuel() {
      const moisCourant = new Date().getMonth(); // 0 = Janvier
      const dejaAjoute = historiqueLabels.includes(document.getElementById("mois").options[moisCourant].text);
      if (!dejaAjoute) {
        setTimeout(() => {
          alert("ðŸ•’ N'oublie pas d'ajouter ton Ã©pargne pour ce mois-ci !");
        }, 1000);
      }
    }

    window.onload = function() {
      updateProgress();
      verifierRappelMensuel();
    }
  </script>

<!-- ====== SECTION ETF CORRIGÃ‰E ====== -->
<div class="container" style="margin-top:2rem;">
  <h2>ðŸ“Š Cours des ETF</h2>

  <label for="etfSearch" style="font-weight:bold;">ðŸ”Ž Rechercher un ETF</label>
  <input type="text" id="etfSearch" placeholder="Ex: VOO, IWDA, MSCI..." oninput="filterETF()" 
         style="width:100%; padding:0.6rem; font-size:1rem; border:1px solid #cfd8dc; border-radius:0.75rem; background-color:#f9f9f9; margin-bottom:1rem;" />

  <ul id="etfList" style="list-style:none; padding-left:0;">
    <li>Chargement des ETF...</li>
  </ul>
</div>

<script>
  const etfs = [
    { name: "MSCI World", ticker: "IWDA.AS" },
    { name: "S&P 500", ticker: "VOO" },
    { name: "Nasdaq 100", ticker: "QQQ" },
    { name: "Emerging Markets", ticker: "IEMG" },
    { name: "Euro Stoxx 50", ticker: "FEZ" },
    { name: "CAC 40", ticker: "^FCHI" },
    { name: "All World", ticker: "VWCE.DE" },
    { name: "Clean Energy", ticker: "ICLN" },
    { name: "Healthcare", ticker: "XLV" },
    { name: "Dividend Aristocrats", ticker: "NOBL" }
  ];

  async function fetchETFPrice(ticker) {
    try {
      const res = await fetch(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${ticker}`);
      const json = await res.json();
      const data = json.quoteResponse.result[0];
      return {
        price: data.regularMarketPrice,
        change: data.regularMarketChangePercent,
      };
    } catch (e) {
      console.error("Erreur de chargement pour", ticker, e);
      return { price: "Erreur", change: 0 };
    }
  }

  async function renderETFs() {
    const list = document.getElementById("etfList");
    list.innerHTML = "";
    for (const etf of etfs) {
      const { price, change } = await fetchETFPrice(etf.ticker);
      const li = document.createElement("li");
      const changeColor = change >= 0 ? '#388e3c' : '#d32f2f';
      li.style.marginBottom = "1rem";
      li.innerHTML = `
        <div style="padding:1rem; border-radius:1rem; background:#f0f4f8; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
          <strong>${etf.name}</strong> (${etf.ticker})<br>
          ðŸ’¶ <span style="font-weight:bold;">${price} â‚¬</span> 
          <span style="color:${changeColor};">(${isNaN(change) ? '' : (change >= 0 ? '+' : '') + change.toFixed(2)}%)</span><br>
          <button onclick="openTradeRepublic()" style="margin-top:0.5rem;">ðŸ“² Ouvrir Trade Republic</button>
        </div>
      `;
      list.appendChild(li);
    }
  }

  function openTradeRepublic() {
    const now = Date.now();
    window.location = "traderepublic://";
    setTimeout(() => {
      if (Date.now() - now < 2000) {
        window.location = "https://www.traderepublic.com/fr-fr";
      }
    }, 1500);
  }

  function filterETF() {
    const term = document.getElementById("etfSearch").value.toLowerCase();
    const items = document.querySelectorAll("#etfList li");
    items.forEach(item => {
      const text = item.innerText.toLowerCase();
      item.style.display = text.includes(term) ? "" : "none";
    });
  }

  window.addEventListener("load", renderETFs);
</script>
<!-- ====== FIN SECTION ETF ====== -->

</body>
</html>
